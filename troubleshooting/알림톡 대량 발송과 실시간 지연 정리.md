# 알림톡 대량 발송과 실시간 지연 정리

## 1. 문제 현상
- **5만 건**을 한 번에 등록하면 벤더(카카오 알림톡 발송 업체 등)가
  내부 **메시징 큐**에 순서대로 적재한다.
- 큐는 **선입선출(FIFO)** 방식이 기본이므로,
  **먼저 등록된 대량 메시지가 모두 처리될 때까지**  
  실시간 알림은 대기 상태가 된다.
- 벤더의 **발송 속도 제한(Rate Limit)**(예: 600건/분)까지 적용되어
  실시간 알림이 더 늦어질 수 있다.

---

## 2. 메시징 큐(Message Queue)란?
- 메시지를 **생산(Producer)** 하는 쪽과 **소비(Consumer)** 하는 쪽을
  분리해 주는 **중간 버퍼**.
- 메시지는 큐에 저장되었다가 소비자가 꺼내 처리한다.
- 벤더 내부에서도 Kafka·RabbitMQ 같은
  MQ를 사용해 발송을 제어한다.
- A→DB→B 구조에서도 DB가 큐 역할을 한다.  
  - A 시스템이 메시지를 **DB에 적재**(Produce)  
  - B 시스템이 DB에서 꺼내 **벤더로 전송**(Consume)

---

## 3. 실시간 지연의 근본 원인
- 대량 발송과 실시간 발송을 **같은 큐**에서 처리
- 우선순위 미설정 + 벤더 발송 속도 제한

---

## 4. 해결 전략

### 4-1. 애플리케이션(A 시스템) 단계
- **Rate Limit 분할**  
  1분 600건 중 예: 400건은 대량, 200건은 실시간으로 자체 쿼터 관리  
  → 등록 자체를 분리하여 실시간 건을 우선 처리
- **스케줄 슬라이싱**  
  5만 건을 5천 건씩 10분 간격으로 `scheduled_at` 분산
- **우선순위/별도 테이블**  
  `priority` 컬럼을 두고 B 시스템이 `priority DESC`로 조회
- **템플릿/브랜드 분리**  
  실시간과 대량을 서로 다른 템플릿/브랜드로 구분하여
  벤더 정책상 다른 레인으로 전송되게 한다.

### 4-2. 벤더 측 옵션
- **채널/계정 분리**  
  실시간과 대량을 다른 발신번호·앱키·계정으로 운영
- **우선순위 라우팅**  
  Priority/Immediate 플래그 지원 시 실시간 건에 적용
- **전용 큐 또는 SLA 협의**  
  실시간 전용 큐 운영, 혹은 벤더와 Rate Limit 상향 협의
- **TTL(만료 시간)**  
  실시간 메시지에 짧은 TTL을 설정해 지연된 발송을 무의미하게 방지

### 4-3. 운영 정책
- **실시간 보호선(Guardrail)**  
  실시간 처리율이 기준 이하일 때 대량 등록 일시 중지
- **캠페인 승인 게이트**  
  대량 등록 전 실시간 대기열 길이/지연이 임계 이상이면
  등록 자체를 지연·축소
- **모니터링 지표**  
  분당 전송량, 대기열 길이, 평균 지연, 벤더 응답코드(429/5xx) 등을
  실시간 모니터링

---

## 5. 핵심 요약
- **문제**: 대량 발송과 실시간 발송을 동일 큐에 넣고
  우선순위를 지정하지 않아 실시간 알림이 뒤로 밀림.
- **해결**:  
  - **우선순위/채널/계정/시간 분리**  
  - **적재·스케줄·쿼터를 분리**  
  - **벤더와 우선순위·Rate Limit 협의**  
- 결과적으로 실시간 알림은 대량 발송과 별도의 경로·정책으로
  처리해야 지연을 방지할 수 있다.
